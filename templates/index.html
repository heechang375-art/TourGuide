<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Travel Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'ko',
                includedLanguages: 'ko,ja,vi,th,zh-CN,zh-TW,en',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element');
        }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    
    <style>
        #google_translate_element { display: none !important; }
        body { top: 0 !important; }
        .skiptranslate, .goog-te-banner-frame, #goog-gt-tt { display: none !important; }
        font { background-color: transparent !important; box-shadow: none !important; }
    </style>
</head>
<body>
    <header class="app-header">
        <!-- ë‚ ì”¨ + í™˜ìœ¨ ì¹´ë“œí˜• -->
        <div class="info-cards">
            <div class="info-card weather-card">
                <div class="info-icon">
                    <i class="fa-solid fa-cloud-sun"></i>
                </div>
                <div class="info-content">
                    <div class="info-label">í˜„ì§€ ë‚ ì”¨</div>
                    <div class="info-value">{{ info.city }} {{ info.temp }}Â°C</div>
                    <div class="info-sub">{{ info.weather_desc }}</div>
                </div>
            </div>
            
            <div class="info-card rate-card">
                <div class="info-icon">
                    <i class="fa-solid fa-coins"></i>
                </div>
                <div class="info-content">
                    <div class="info-label">í™˜ìœ¨</div>
                    <div class="info-value" id="rateDisplay">
                        {% if info.currency in ['JPY', 'VND'] %}
                            {{ (info.rate_calc * 100) | round(2) }}ì›
                        {% else %}
                            {{ info.rate_display }}ì›
                        {% endif %}
                    </div>
                    <div class="info-sub">
                        {% if info.currency in ['JPY', 'VND'] %}
                            100 {{ info.currency }}
                        {% else %}
                            1 {{ info.currency }}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- êµ­ê°€ ì„ íƒ (êµ­ê¸° ì´ëª¨ì§€ í¬í•¨) -->
        <div class="country-selector-wrapper">
            <label class="selector-label">ğŸŒ ì—¬í–‰ì§€ ì„ íƒ</label>
            <select class="country-selector" onchange="changeCity(this.value)">
                {% for id, c in countries.items() %}
                <option value="{{ id }}" {% if id == selected_id %}selected{% endif %}>{{ c.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- ì–¸ì–´ ì„ íƒ (ë²„íŠ¼ ê·¸ë¦¬ë“œ) -->
        <div class="lang-selector-wrapper">
            <label class="selector-label">ğŸ—£ï¸ ì–¸ì–´ ì„ íƒ</label>
            <div class="lang-grid" id="customLangSelect">
                <button class="lang-btn" data-lang="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</button>
                <button class="lang-btn" data-lang="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</button>
                <button class="lang-btn" data-lang="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</button>
                <button class="lang-btn" data-lang="th">ğŸ‡¹ğŸ‡­ à¹„à¸—à¸¢</button>
                <button class="lang-btn" data-lang="zh-CN">ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</button>
                <button class="lang-btn" data-lang="zh-TW">ğŸ‡­ğŸ‡° ç¹é«”ä¸­æ–‡</button>
                <button class="lang-btn" data-lang="en">ğŸ‡ºğŸ‡¸ English</button>
            </div>
        </div>
    </header>

    <nav class="mobile-tabs">
        <button onclick="showTab(event, 'info')" class="tab-btn active">
            <i class="fa-solid fa-circle-info"></i>
            <span>ì •ë³´</span>
        </button>
        <button onclick="showTab(event, 'shopping')" class="tab-btn">
            <i class="fa-solid fa-bag-shopping"></i>
            <span>ì‡¼í•‘</span>
        </button>
        <button onclick="showTab(event, 'phrases')" class="tab-btn">
            <i class="fa-solid fa-comments"></i>
            <span>íšŒí™”</span>
        </button>
        <button onclick="showTab(event, 'calc')" class="tab-btn">
            <i class="fa-solid fa-calculator"></i>
            <span>í™˜ìœ¨</span>
        </button>
        <button onclick="showTab(event, 'todo')" class="tab-btn">
            <i class="fa-solid fa-list-check"></i>
            <span>ì²´í¬</span>
        </button>
    </nav>

    <main class="content-area">
        <div id="info" class="tab-content active">
            <div class="card translation-card">
                <h3><i class="fa-solid fa-language"></i> ì‹¤ì‹œê°„ ë²ˆì—­ê¸°</h3>
                <div class="translator-container">
                    <textarea id="sourceText" class="trans-input" placeholder="ë²ˆì—­í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    <div id="transResult" class="trans-output-box" style="display:none;"></div>
                    <div class="trans-btn-grid">
                        <button type="button" onclick="translateAction('target')" class="btn-primary" id="targetLangBtn">í˜„ì§€ì–´ë¡œ</button>
                        <button type="button" onclick="translateAction('ko')" class="btn-success">í•œêµ­ì–´ë¡œ</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fa-solid fa-lightbulb"></i> ì—¬í–‰ ê¿€íŒ & ì£¼ì˜ì‚¬í•­</h3>
                <div class="tip-section">
                    <div class="tip-header">âœ… ê¿€íŒ</div>
                    <ul class="data-list">{% for tip in info.tips %}<li>{{ tip }}</li>{% endfor %}</ul>
                </div>
                <div class="warning-section">
                    <div class="warning-header">âš ï¸ ì£¼ì˜ì‚¬í•­</div>
                    <ul class="data-list">{% for warn in info.warnings %}<li>{{ warn }}</li>{% endfor %}</ul>
                </div>
            </div>

            <div class="card">
                <h3><i class="fa-solid fa-mobile-screen-button"></i> í•„ìˆ˜ ì–´í”Œ</h3>
                {% for app in info.apps %}
                <div class="app-item-modern">
                    <div class="app-icon-wrapper">
                        <i class="fa-solid fa-mobile-screen"></i>
                    </div>
                    <div class="app-info">
                        <strong>{{ app.name }}</strong>
                        <small>{{ app.desc }}</small>
                    </div>
                    {% if 'play.google.com' in app.link %}
                        <a href="market://details?id={{ app.link.split('id=')[1] }}" class="app-download-btn">
                            <i class="fa-brands fa-google-play"></i>
                            <span>ë‹¤ìš´ë¡œë“œ</span>
                        </a>
                    {% else %}
                        <a href="{{ app.link }}" target="_blank" class="app-download-btn web-btn">
                            <i class="fa-solid fa-globe"></i>
                            <span>ì›¹ì‚¬ì´íŠ¸</span>
                        </a>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <div id="shopping" class="tab-content">
            <div class="card">
                <h3><i class="fa-solid fa-cart-shopping"></i> ì¶”ì²œ ì‡¼í•‘í…œ</h3>
                <div class="shopping-grid">
                    {% for item in info.shopping %}
                    <a href="https://www.google.com/search?q={{ info.city }}+{{ item }}&tbm=isch" target="_blank" class="shop-item">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <span>{{ item }}</span>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div id="phrases" class="tab-content">
            {% for cat, items in info.phrases.items() %}
            <div class="phrase-card">
                <div class="phrase-header">{{ cat }}</div>
                {% for p in items %}
                <div class="phrase-item">
                    <p class="txt-ko">{{ p.ko }}</p>
                    <p class="txt-local">{{ p.local }}</p>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>

        <div id="calc" class="tab-content">
            <div class="card">
                <h3><i class="fa-solid fa-money-bill-transfer"></i> í™˜ìœ¨ ê³„ì‚°ê¸°</h3>
                <div class="calc-box-improved">
                    <div class="calc-row">
                        <span class="currency-label">{{ info.currency }}</span>
                        <input type="number" id="foreignInput" class="calc-input" placeholder="0" value="">
                    </div>
                    <div class="calc-arrow">
                        <i class="fa-solid fa-arrow-down"></i>
                    </div>
                    <div class="calc-row">
                        <span class="currency-label">KRW</span>
                        <input type="text" id="krwOutput" class="calc-output" placeholder="0 ì›" readonly>
                    </div>
                    <button class="calc-btn" onclick="calculateExchange()">
                        <i class="fa-solid fa-calculator"></i> ê³„ì‚°í•˜ê¸°
                    </button>
                    {% if info.currency in ['JPY', 'VND'] %}
                    <div id="unitInfo" class="calc-unit-info">
                        <i class="fa-solid fa-circle-info"></i>
                        <strong>í™˜ì „ ë‹¨ìœ„ ì•ˆë‚´:</strong> 
                        <span id="unitText">100{{ 'ì—”' if info.currency == 'JPY' else 'ë™' }} ë‹¨ìœ„ë¡œ í™˜ì „ ê°€ëŠ¥</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div id="todo" class="tab-content">
            <div class="card">
                <h3><i class="fa-solid fa-clipboard-check"></i> ì—¬í–‰ ì¤€ë¹„ ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>
                
                {% for category, items in checklist.items() %}
                <div class="checklist-category">
                    <h4>{{ category }}</h4>
                    {% for item in items %}
                    <div class="checklist-item">
                        <input type="checkbox" id="check_{{ loop.index0 }}_{{ loop.index }}">
                        <label for="check_{{ loop.index0 }}_{{ loop.index }}">{{ item }}</label>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
    </main>

    <script>
        const currentRate = {{ info.rate_calc }};
        const currentCurrency = "{{ info.currency }}";
        const currentTargetLang = "{{ info.city|lower|replace(' ', '') }}";
        let userSelectedLang = null;

        // ì–¸ì–´ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const lang = this.dataset.lang;
                forceTranslateUI(lang);
            });
        });

        function forceTranslateUI(langCode) {
            if (!langCode) return;
            
            userSelectedLang = langCode;
            
            const gtCombo = document.querySelector('.goog-te-combo');
            if (gtCombo) {
                gtCombo.value = langCode;
                gtCombo.dispatchEvent(new Event('change'));
            }
            
            document.cookie = `googtrans=/ko/${langCode}; path=/;`;
            
            if ("{{ selected_id }}" === "seoul" && langCode !== "ko") {
                updateReverseRate(langCode);
            } else {
                restoreOriginalRate();
            }
            
            updateTargetButton();
        }

        function updateReverseRate(langCode) {
            const langToCurrency = {
                'ja': { code: 'JPY', name: 'ì—”' },
                'vi': { code: 'VND', name: 'ë™' },
                'th': { code: 'THB', name: 'ë°”íŠ¸' },
                'zh-CN': { code: 'CNY', name: 'ìœ„ì•ˆ' },
                'zh-TW': { code: 'TWD', name: 'ë‹¬ëŸ¬' },
                'en': { code: 'USD', name: 'ë‹¬ëŸ¬' }
            };
            
            const targetCurrency = langToCurrency[langCode];
            if (!targetCurrency) return;
            
            fetch(`https://open.er-api.com/v6/latest/KRW`)
                .then(res => res.json())
                .then(data => {
                    const reverseRate = data.rates[targetCurrency.code];
                    const rateDisplay = document.getElementById('rateDisplay');
                    
                    if (targetCurrency.code === 'JPY' || targetCurrency.code === 'VND') {
                        const rate100 = (reverseRate * 100).toFixed(2);
                        rateDisplay.innerHTML = `${rate100} ${targetCurrency.name}`;
                    } else {
                        rateDisplay.innerHTML = `${reverseRate.toFixed(2)} ${targetCurrency.name}`;
                    }
                })
                .catch(err => console.error('í™˜ìœ¨ ì¡°íšŒ ì‹¤íŒ¨:', err));
        }

        function restoreOriginalRate() {
            const rateDisplay = document.getElementById('rateDisplay');
            {% if info.currency in ['JPY', 'VND'] %}
                rateDisplay.innerHTML = `{{ (info.rate_calc * 100) | round(2) }}ì›`;
            {% else %}
                rateDisplay.innerHTML = `{{ info.rate_display }}ì›`;
            {% endif %}
        }

        function changeCity(cityId) {
            document.cookie = "googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            document.cookie = `googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=${location.hostname};`;
            window.location.href = '/?country=' + cityId;
        }

        function roundToUnit(value, unit) {
            return Math.round(value / unit) * unit;
        }

        function calculateExchange() {
            const foreignInput = document.getElementById('foreignInput');
            const krwOutput = document.getElementById('krwOutput');
            let val = parseFloat(foreignInput.value);
            
            if (!val || isNaN(val)) {
                alert('ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (currentCurrency === 'VND' || currentCurrency === 'JPY') {
                const rounded = roundToUnit(val, 100);
                if (rounded !== val) {
                    foreignInput.value = rounded;
                    val = rounded;
                    alert(`${currentCurrency}ëŠ” 100ë‹¨ìœ„ë¡œë§Œ í™˜ì „ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n${rounded}ìœ¼ë¡œ ì¡°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }
            }

            const krwAmount = Math.round(val * currentRate);
            krwOutput.value = krwAmount.toLocaleString() + " ì›";
        }

        window.onload = function() {
            const match = document.cookie.match(/googtrans=\/ko\/([^;]+)/);
            if (match) { 
                userSelectedLang = match[1];
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    if (btn.dataset.lang === match[1]) {
                        btn.classList.add('active');
                    }
                });
                
                if ("{{ selected_id }}" === "seoul" && match[1] !== "ko") {
                    updateReverseRate(match[1]);
                }
            }
            
            updateTargetButton();

            document.getElementById('foreignInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    calculateExchange();
                }
            });
        };

        function translateAction(mode) {
            const text = document.getElementById('sourceText').value;
            if(!text) {
                alert('ë²ˆì—­í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            let targetLang;
            if (mode === 'target') {
                targetLang = userSelectedLang || currentTargetLang;
            } else {
                targetLang = 'ko';
            }
            
            fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`)
            .then(res => res.json()).then(data => {
                const rb = document.getElementById('transResult');
                if (data && data[0] && data[0][0][0]) { 
                    rb.innerText = data[0][0][0]; 
                    rb.style.display = 'block'; 
                }
            }).catch(err => {
                console.error('Translation error:', err);
                alert('ë²ˆì—­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }

        function updateTargetButton() {
            const btn = document.getElementById('targetLangBtn');
            const langNames = {
                'ko': 'í•œêµ­ì–´',
                'ja': 'ì¼ë³¸ì–´',
                'vi': 'ë² íŠ¸ë‚¨ì–´',
                'th': 'íƒœêµ­ì–´',
                'zh-CN': 'ì¤‘êµ­ì–´',
                'zh-TW': 'ì¤‘êµ­ì–´',
                'en': 'ì˜ì–´'
            };
            
            const targetLang = userSelectedLang || currentTargetLang;
            const langName = langNames[targetLang] || 'í˜„ì§€ì–´';
            btn.innerText = `${langName}ë¡œ`;
        }

        function showTab(event, id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }
    </script>
</body>
</html>
