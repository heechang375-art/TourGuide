<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Travel Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'ko',
                includedLanguages: 'ko,ja,vi,th,zh-CN,zh-TW,en',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element');
        }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    
    <style>
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #fff; }
        #google_translate_element { display: none !important; }
        
        /* ì–¸ì–´ ì„ íƒ ë“œë¡­ë‹¤ìš´ */
        .lang-blue-selector {
            width: 100%;
            padding: 14px;
            margin-top: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        /* í™˜ìœ¨ ê³„ì‚°ê¸° UI */
        .calc-box-improved { padding: 20px; background: #f8f9fa; border-radius: 12px; }
        .calc-row { display: flex; align-items: center; margin-bottom: 15px; background: white; padding: 12px 15px; border-radius: 8px; border: 1px solid #ddd; }
        .currency-label { width: 70px; font-weight: bold; color: #333; font-size: 1.1rem; }
        .calc-input, .calc-output { flex: 1; border: none; font-size: 1.3rem; font-weight: bold; text-align: right; outline: none; }
        .calc-btn { width: 100%; padding: 15px; background: #007AFF; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; margin-top: 10px; }
        .calc-btn:active { background: #0056b3; }

        /* ì‡¼í•‘ ê·¸ë¦¬ë“œ */
        .shopping-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .shop-item { 
            display: flex; align-items: center; justify-content: center; gap: 8px;
            padding: 15px 10px; background: #fff; border: 1px solid #eee; border-radius: 10px;
            text-decoration: none; color: #333; font-weight: 500; font-size: 0.95rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .shop-item i { color: #007bff; font-size: 0.8rem; }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        .mobile-tabs { position: sticky; top: 0; background: #fff; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-btn { padding: 16px 0; font-size: 14px; transition: all 0.2s; }
        .tab-btn:active { background: #f0f0f0; }
        
        .card { margin: 12px; padding: 18px; border-radius: 16px; }
        .trans-input { font-size: 15px; padding: 12px; }
        .phrase-card { margin: 12px; padding: 16px; }

        body { top: 0 !important; }
        .skiptranslate, .goog-te-banner-frame, #goog-gt-tt { display: none !important; }
        font { background-color: transparent !important; box-shadow: none !important; }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="header-top-info">
            <div class="weather-badge">
                <i class="fa-solid fa-cloud-sun"></i> 
                {{ info.city }} {{ info.temp }}Â°C
            </div>
            <div class="rate-compact" id="rateDisplay">
                {% if info.currency in ['JPY', 'VND'] %}
                    <div class="rate-compact-main">{{ (info.rate_calc * 100) | round(2) }}ì›</div>
                    <div class="rate-compact-sub">100 {{ info.currency }}</div>
                {% else %}
                    <div class="rate-compact-main">{{ info.rate_display }}ì›</div>
                    <div class="rate-compact-sub">1 {{ info.currency }}</div>
                {% endif %}
            </div>
        </div>

        <div class="selection-area">
            <select class="main-selector" onchange="changeCity(this.value)">
                {% for id, c in countries.items() %}
                <option value="{{ id }}" {% if id == selected_id %}selected{% endif %}>{{ c.name }}</option>
                {% endfor %}
            </select>

            <select id="customLangSelect" class="lang-blue-selector notranslate" onchange="forceTranslateUI(this.value)">
                <option value="">ì–¸ì–´ ì„ íƒ (Language)</option>
                <option value="ko">í•œêµ­ì–´ (KR)</option>
                <option value="ja">ì¼ë³¸ì–´ (JP)</option>
                <option value="vi">ë² íŠ¸ë‚¨ì–´ (VN)</option>
                <option value="th">íƒœêµ­ì–´ (TH)</option>
                <option value="zh-CN">ì¤‘êµ­ì–´ ê°„ì²´ (CN)</option>
                <option value="zh-TW">ì¤‘êµ­ì–´ ë²ˆì²´ (HK)</option>
                <option value="en">ì˜ì–´ (US)</option>
            </select>
        </div>
    </header>

    <nav class="mobile-tabs">
        <button onclick="showTab(event, 'info')" class="tab-btn active">ì •ë³´</button>
        <button onclick="showTab(event, 'shopping')" class="tab-btn">ì‡¼í•‘</button>
        <button onclick="showTab(event, 'phrases')" class="tab-btn">íšŒí™”</button>
        <button onclick="showTab(event, 'calc')" class="tab-btn">í™˜ìœ¨</button>
        <button onclick="showTab(event, 'todo')" class="tab-btn">ì²´í¬</button>
    </nav>

    <main class="content-area">
        <div id="info" class="tab-content active">
            <div class="card translation-card">
                <h3><i class="fa-solid fa-language"></i> ì‹¤ì‹œê°„ ë²ˆì—­ê¸°</h3>
                <div class="translator-container">
                    <textarea id="sourceText" class="trans-input" placeholder="ë²ˆì—­í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    <div id="transResult" class="trans-output-box" style="display:none;"></div>
                    <div class="trans-btn-grid">
                        <button type="button" onclick="translateAction('target')" class="btn-primary" id="targetLangBtn">í˜„ì§€ì–´ë¡œ</button>
                        <button type="button" onclick="translateAction('ko')" class="btn-success">í•œêµ­ì–´ë¡œ</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3>ğŸ’¡ ì—¬í–‰ ê¿€íŒ & ì£¼ì˜ì‚¬í•­</h3>
                <ul class="data-list">{% for tip in info.tips %}<li>{{ tip }}</li>{% endfor %}</ul>
                <ul class="data-list" style="color: #d9534f;">{% for warn in info.warnings %}<li>{{ warn }}</li>{% endfor %}</ul>
            </div>

            <div class="card">
                <h3>ğŸ“± í•„ìˆ˜ ì–´í”Œ</h3>
                {% for app in info.apps %}
                <div class="app-item-row" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee;">
                    <div class="app-info"><strong>{{ app.name }}</strong><br><small style="color: #666;">{{ app.desc }}</small></div>
                    {% if 'play.google.com' in app.link %}
                        <a href="market://details?id={{ app.link.split('id=')[1] }}" style="color: #007bff; font-size: 1.5rem;"><i class="fa-solid fa-circle-arrow-down"></i></a>
                    {% else %}
                        <a href="{{ app.link }}" target="_blank" style="color: #007bff; font-size: 1.5rem;"><i class="fa-solid fa-external-link-alt"></i></a>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <div id="shopping" class="tab-content">
            <div class="card">
                <h3>ğŸ›’ ì¶”ì²œ ì‡¼í•‘í…œ</h3>
                <div class="shopping-grid">
                    {% for item in info.shopping %}
                    <a href="https://www.google.com/search?q={{ info.city }}+{{ item }}&tbm=isch" target="_blank" class="shop-item">
                        <i class="fa-solid fa-magnifying-glass"></i> {{ item }}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div id="phrases" class="tab-content">
            {% for cat, items in info.phrases.items() %}
            <div class="phrase-card">
                <div class="phrase-header">{{ cat }}</div>
                {% for p in items %}
                <div class="phrase-row"><p class="txt-ko">{{ p.ko }}</p><p class="txt-local">{{ p.local }}</p></div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>

        <div id="calc" class="tab-content">
            <div class="card">
                <h3>ğŸ”¢ í™˜ìœ¨ ê³„ì‚°ê¸°</h3>
                <div class="calc-box-improved">
                    <div class="calc-row">
                        <span class="currency-label" id="currencyLabel">{{ info.currency }}</span>
                        <input type="number" id="foreignInput" class="calc-input" placeholder="0" step="any">
                    </div>
                    <div class="calc-row">
                        <span class="currency-label">KRW</span>
                        <input type="text" id="krwOutput" class="calc-output" readonly placeholder="0">
                    </div>
                    <button class="calc-btn" onclick="calculateExchange()">ğŸ’± í™˜ìœ¨ ê³„ì‚°í•˜ê¸°</button>
                    <div class="calc-unit-info" id="unitInfo" style="display:none;">
                        <strong>ğŸ’° í™˜ì „ ê°€ëŠ¥ ë‹¨ìœ„:</strong> <span id="unitText"></span>
                    </div>
                </div>
            </div>
        </div>

        <div id="todo" class="tab-content">
            <div class="card">
                <h3>âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>
                {% for cat, items in checklist.items() %}
                <div class="todo-group">
                    <h4>{{ cat }}</h4>
                    {% for item in items %}<label style="display:block; margin:5px 0;"><input type="checkbox"> {{ item }}</label>{% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
    </main>

    <script>
        const cityLangMap = {
            'tokyo':'ja', 'osaka':'ja', 'fukuoka':'ja', 'danang':'vi', 
            'hochiminh':'vi', 'bangkok':'th', 'taipei':'zh-TW', 
            'hongkong':'zh-TW', 'nyc':'en', 'seoul':'ko'
        };
        
        let currentTargetLang = cityLangMap["{{ selected_id }}"] || 'ko';
        let userSelectedLang = null;
        let currentCurrency = "{{ info.currency }}";
        let currentRate = parseFloat("{{ info.rate_calc }}");

        function forceTranslateUI(langCode) {
            if(!langCode) return;
            userSelectedLang = langCode;
            
            // ì„œìš¸ì´ê³  í•œêµ­ì–´ê°€ ì•„ë‹Œ ë‹¤ë¥¸ ì–¸ì–´ë¥¼ ì„ íƒí–ˆì„ ë•Œ ì—­í™˜ìœ¨ í‘œì‹œ
            if ("{{ selected_id }}" === "seoul" && langCode !== "ko") {
                updateReverseRate(langCode);
            } else {
                // ì›ë˜ í™˜ìœ¨ë¡œ ë³µì›
                restoreOriginalRate();
            }
            
            document.cookie = `googtrans=/ko/${langCode}; path=/`;
            document.cookie = `googtrans=/ko/${langCode}; domain=${location.hostname}; path=/`;
            const baseUrl = window.location.href.split('#')[0];
            window.location.href = baseUrl + '#googtrans(ko|' + langCode + ')';
            location.reload();
        }

        function updateReverseRate(langCode) {
            // ì–¸ì–´ë³„ í†µí™” ë§¤í•‘
            const langToCurrency = {
                'ja': { code: 'JPY', name: 'ì—”' },
                'vi': { code: 'VND', name: 'ë™' },
                'th': { code: 'THB', name: 'ë°”íŠ¸' },
                'zh-CN': { code: 'CNY', name: 'ìœ„ì•ˆ' },
                'zh-TW': { code: 'TWD', name: 'ë‹¬ëŸ¬' },
                'en': { code: 'USD', name: 'ë‹¬ëŸ¬' }
            };
            
            const targetCurrency = langToCurrency[langCode];
            if (!targetCurrency) return;
            
            // ì—­í™˜ìœ¨ ê³„ì‚°ì„ ìœ„í•´ í•´ë‹¹ í†µí™”ì˜ í™˜ìœ¨ ê°€ì ¸ì˜¤ê¸°
            fetch(`https://open.er-api.com/v6/latest/KRW`)
                .then(res => res.json())
                .then(data => {
                    const reverseRate = data.rates[targetCurrency.code];
                    const rateDisplay = document.getElementById('rateDisplay');
                    
                    if (targetCurrency.code === 'JPY' || targetCurrency.code === 'VND') {
                        const rate100 = (reverseRate * 100).toFixed(2);
                        rateDisplay.innerHTML = `
                            <div class="rate-compact-main">${rate100} ${targetCurrency.name}</div>
                            <div class="rate-compact-sub">1000 KRW</div>
                        `;
                    } else {
                        rateDisplay.innerHTML = `
                            <div class="rate-compact-main">${reverseRate.toFixed(2)} ${targetCurrency.name}</div>
                            <div class="rate-compact-sub">1000 KRW</div>
                        `;
                    }
                })
                .catch(err => console.error('í™˜ìœ¨ ì¡°íšŒ ì‹¤íŒ¨:', err));
        }

        function restoreOriginalRate() {
            const rateDisplay = document.getElementById('rateDisplay');
            {% if info.currency in ['JPY', 'VND'] %}
                rateDisplay.innerHTML = `
                    <div class="rate-compact-main">{{ (info.rate_calc * 100) | round(2) }}ì›</div>
                    <div class="rate-compact-sub">100 {{ info.currency }}</div>
                `;
            {% else %}
                rateDisplay.innerHTML = `
                    <div class="rate-compact-main">{{ info.rate_display }}ì›</div>
                    <div class="rate-compact-sub">1 {{ info.currency }}</div>
                `;
            {% endif %}
        }

        function changeCity(cityId) {
            document.cookie = "googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            document.cookie = `googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=${location.hostname};`;
            window.location.href = '/?country=' + cityId;
        }

        function roundToUnit(value, unit) {
            return Math.round(value / unit) * unit;
        }

        function calculateExchange() {
            const foreignInput = document.getElementById('foreignInput');
            const krwOutput = document.getElementById('krwOutput');
            let val = parseFloat(foreignInput.value);
            
            if (!val || isNaN(val)) {
                alert('ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // JPY, VNDëŠ” 100ë‹¨ìœ„ë¡œ ìë™ ë°˜ì˜¬ë¦¼
            if (currentCurrency === 'VND' || currentCurrency === 'JPY') {
                const rounded = roundToUnit(val, 100);
                if (rounded !== val) {
                    foreignInput.value = rounded;
                    val = rounded;
                    alert(`${currentCurrency}ëŠ” 100ë‹¨ìœ„ë¡œë§Œ í™˜ì „ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n${rounded}ìœ¼ë¡œ ì¡°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }
            }

            // ì›í™” ê³„ì‚°
            const krwAmount = Math.round(val * currentRate);
            krwOutput.value = krwAmount.toLocaleString() + " ì›";
        }

        window.onload = function() {
            // í™˜ì „ ë‹¨ìœ„ ì•ˆë‚´ í‘œì‹œ
            if (currentCurrency === 'VND' || currentCurrency === 'JPY') {
                const unitInfo = document.getElementById('unitInfo');
                const unitText = document.getElementById('unitText');
                const unitName = currentCurrency === 'VND' ? 'ë™' : 'ì—”';
                unitText.innerText = `100${unitName} ë‹¨ìœ„ë¡œ í™˜ì „ ê°€ëŠ¥`;
                unitInfo.style.display = 'block';
            }

            // ì¿ í‚¤ì—ì„œ í˜„ì¬ ì–¸ì–´ í™•ì¸
            const match = document.cookie.match(/googtrans=\/ko\/([^;]+)/);
            if (match) { 
                userSelectedLang = match[1];
                document.getElementById('customLangSelect').value = match[1];
                
                // ì„œìš¸ì´ê³  í•œêµ­ì–´ê°€ ì•„ë‹ˆë©´ ì—­í™˜ìœ¨ í‘œì‹œ
                if ("{{ selected_id }}" === "seoul" && match[1] !== "ko") {
                    updateReverseRate(match[1]);
                }
            }
            
            // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            updateTargetButton();

            // Enter í‚¤ë¡œ ê³„ì‚°
            document.getElementById('foreignInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    calculateExchange();
                }
            });
        };

        function translateAction(mode) {
            const text = document.getElementById('sourceText').value;
            if(!text) {
                alert('ë²ˆì—­í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            let targetLang;
            if (mode === 'target') {
                // í˜„ì§€ì–´ë¡œ ë²„íŠ¼ í´ë¦­
                targetLang = userSelectedLang || currentTargetLang;
            } else {
                // í•œêµ­ì–´ë¡œ ë²„íŠ¼ í´ë¦­
                targetLang = 'ko';
            }
            
            fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`)
            .then(res => res.json()).then(data => {
                const rb = document.getElementById('transResult');
                if (data && data[0] && data[0][0][0]) { 
                    rb.innerText = data[0][0][0]; 
                    rb.style.display = 'block'; 
                }
            }).catch(err => {
                console.error('Translation error:', err);
                alert('ë²ˆì—­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }

        function updateTargetButton() {
            const btn = document.getElementById('targetLangBtn');
            const langNames = {
                'ko': 'í•œêµ­ì–´',
                'ja': 'ì¼ë³¸ì–´',
                'vi': 'ë² íŠ¸ë‚¨ì–´',
                'th': 'íƒœêµ­ì–´',
                'zh-CN': 'ì¤‘êµ­ì–´',
                'zh-TW': 'ì¤‘êµ­ì–´',
                'en': 'ì˜ì–´'
            };
            
            const targetLang = userSelectedLang || currentTargetLang;
            const langName = langNames[targetLang] || 'í˜„ì§€ì–´';
            btn.innerText = `${langName}ë¡œ`;
        }

        function showTab(event, id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }
    </script>
</body>
</html>
