<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Travel Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'ko',
                includedLanguages: 'ko,ja,vi,th,zh-CN,zh-TW,en',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element');
        }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    
    <style>
        #google_translate_element { display: none !important; }
        body { top: 0 !important; }
        .skiptranslate, .goog-te-banner-frame, #goog-gt-tt { display: none !important; }
        font { background-color: transparent !important; box-shadow: none !important; }
    </style>
</head>
<body>
    <header class="app-header">
        <!-- ë‚ ì”¨ + í™˜ìœ¨ ì¹´ë“œ -->
        <div class="info-cards">
            <div class="info-card weather-card">
                <div class="info-icon">
                    <i class="fa-solid fa-cloud-sun"></i>
                </div>
                <div class="info-content">
                    <div class="info-label">í˜„ì§€ ë‚ ì”¨</div>
                    <div class="info-value">{{ info.city }} {{ info.temp }}Â°C</div>
                    <div class="info-sub">{{ info.weather_desc }}</div>
                </div>
            </div>
            
            <div class="info-card rate-card">
                <div class="info-icon">
                    <i class="fa-solid fa-coins"></i>
                </div>
                <div class="info-content">
                    <div class="info-label">í™˜ìœ¨</div>
                    <div class="info-value" id="rateDisplay"></div>
                    <div class="info-sub">
                        {% if info.currency in ['JPY', 'VND'] %}
                            100 {{ info.currency }}
                        {% else %}
                            1 {{ info.currency }}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- ì—¬í–‰ì§€ + ì–¸ì–´ ì„ íƒ (í•œ ì¤„) -->
        <div class="selector-row">
            <div class="selector-col">
                <label class="selector-label">ğŸŒ ì—¬í–‰ì§€</label>
                <select class="compact-selector" onchange="changeCity(this.value)">
                    {% for id, c in countries.items() %}
                    <option value="{{ id }}" {% if id == selected_id %}selected{% endif %}>{{ c.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="selector-col">
                <label class="selector-label">ğŸ—£ï¸ ì–¸ì–´</label>
                <select class="compact-selector" id="langSelector" onchange="changeLang(this.value)">
                    <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                    <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                    <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
                    <option value="th">ğŸ‡¹ğŸ‡­ à¹„à¸—à¸¢</option>
                    <option value="zh-CN">ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</option>
                    <option value="zh-TW">ğŸ‡­ğŸ‡° ç¹é«”ä¸­æ–‡</option>
                    <option value="en">ğŸ‡ºğŸ‡¸ English</option>
                </select>
            </div>
        </div>
    </header>

    <nav class="mobile-tabs">
        <button onclick="showTab(event, 'info')" class="tab-btn active">
            <i class="fa-solid fa-circle-info"></i>
            <span>ì •ë³´</span>
        </button>
        <button onclick="showTab(event, 'phrases')" class="tab-btn">
            <i class="fa-solid fa-comments"></i>
            <span>íšŒí™”</span>
        </button>
        <button onclick="showTab(event, 'shopping')" class="tab-btn">
            <i class="fa-solid fa-bag-shopping"></i>
            <span>ì‡¼í•‘</span>
        </button>
        <button onclick="showTab(event, 'calc')" class="tab-btn">
            <i class="fa-solid fa-calculator"></i>
            <span>í™˜ìœ¨</span>
        </button>
        <button onclick="showTab(event, 'todo')" class="tab-btn">
            <i class="fa-solid fa-list-check"></i>
            <span>ì²´í¬</span>
        </button>
    </nav>

    <main class="content-area">
        <!-- ì •ë³´ íƒ­ -->
        <div id="info" class="tab-content active">
            <!-- ë²ˆì—­ê¸° (ì••ì¶•) -->
            <div class="card compact-card">
                <h3><i class="fa-solid fa-language"></i> ë²ˆì—­ê¸°</h3>
                <textarea id="sourceText" class="trans-input-compact" placeholder="ë²ˆì—­í•  ë‚´ìš© ì…ë ¥..."></textarea>
                <div id="transResult" class="trans-output-compact" style="display:none;"></div>
                <div class="trans-btn-grid">
                    <button onclick="translateAction('target')" class="btn-primary" id="targetLangBtn">í˜„ì§€ì–´ë¡œ</button>
                    <button onclick="translateAction('ko')" class="btn-success" id="koreanBtn">í•œêµ­ì–´ë¡œ</button>
                </div>
            </div>
            
            <!-- ì—¬í–‰ íŒ (ì••ì¶•) -->
            <div class="card compact-card">
                <h3><i class="fa-solid fa-lightbulb"></i> íŒ & ì£¼ì˜ì‚¬í•­</h3>
                <div class="tip-compact">
                    <strong>âœ… ê¿€íŒ</strong>
                    <ul class="compact-list">{% for tip in info.tips %}<li>{{ tip }}</li>{% endfor %}</ul>
                </div>
                <div class="warning-compact">
                    <strong>âš ï¸ ì£¼ì˜</strong>
                    <ul class="compact-list">{% for warn in info.warnings %}<li>{{ warn }}</li>{% endfor %}</ul>
                </div>
            </div>

            <!-- í•„ìˆ˜ ì•± (ì••ì¶•) -->
            <div class="card compact-card">
                <h3><i class="fa-solid fa-mobile-screen-button"></i> í•„ìˆ˜ ì•±</h3>
                {% for app in info.apps %}
                <div class="app-item-compact">
                    <div class="app-icon-small">
                        <i class="fa-solid fa-mobile-screen"></i>
                    </div>
                    <div class="app-info-small">
                        <strong>{{ app.name }}</strong>
                        <small>{{ app.desc }}</small>
                    </div>
                    <a href="{{ app.link }}" target="_blank" class="app-btn-small">
                        <i class="fa-solid fa-download"></i>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- íšŒí™” íƒ­ -->
        <div id="phrases" class="tab-content">
            <!-- íšŒí™” ì¹´í…Œê³ ë¦¬ íƒ­ -->
            <div class="phrase-tabs">
                {% set categories = info.phrases.keys() | list %}
                {% for cat in categories %}
                <button class="phrase-tab-btn {% if loop.first %}active{% endif %}" onclick="showPhraseTab(event, 'cat{{ loop.index0 }}')">
                    {{ cat.split(' ')[0] }}
                </button>
                {% endfor %}
            </div>

            <!-- íšŒí™” ë‚´ìš© -->
            {% for cat, items in info.phrases.items() %}
            <div id="cat{{ loop.index0 }}" class="phrase-tab-content {% if loop.first %}active{% endif %}">
                <div class="phrase-card-new">
                    {% for p in items %}
                    <div class="phrase-item-new">
                        <div class="phrase-ko">{{ p.ko }}</div>
                        <div class="phrase-local">{{ p.local }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- ì‡¼í•‘ íƒ­ -->
        <div id="shopping" class="tab-content">
            <div class="card">
                <h3><i class="fa-solid fa-cart-shopping"></i> ì¶”ì²œ ì‡¼í•‘í…œ</h3>
                <div class="shopping-grid">
                    {% for item in info.shopping %}
                    <a href="https://www.google.com/search?q={{ info.city }}+{{ item }}&tbm=isch" target="_blank" class="shop-item">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <span>{{ item }}</span>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- í™˜ìœ¨ ê³„ì‚°ê¸° íƒ­ -->
        <div id="calc" class="tab-content">
            <div class="card">
                <h3><i class="fa-solid fa-calculator"></i> í™˜ìœ¨ ê³„ì‚°ê¸°</h3>
                <div class="calc-box-improved">
                    <div class="calc-row">
                        <div class="currency-label">{{ info.currency }}</div>
                        <input type="text" id="foreignInput" class="calc-input" placeholder="0" inputmode="numeric">
                    </div>
                    <div class="calc-arrow">
                        <i class="fa-solid fa-arrow-down"></i>
                    </div>
                    <div class="calc-row">
                        <div class="currency-label">KRW</div>
                        <input type="text" id="krwOutput" class="calc-output" readonly placeholder="0 ì›">
                    </div>
                    <button onclick="calculateExchange()" class="calc-btn">
                        <i class="fa-solid fa-calculator"></i>
                        ê³„ì‚°í•˜ê¸°
                    </button>
                    {% if info.currency in ['JPY', 'VND'] %}
                    <div class="calc-unit-info">
                        <i class="fa-solid fa-circle-info"></i>
                        <span><strong>{{ info.currency }}</strong>ëŠ” 100 ë‹¨ìœ„ë¡œë§Œ í™˜ì „ ê°€ëŠ¥í•©ë‹ˆë‹¤</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ì²´í¬ë¦¬ìŠ¤íŠ¸ íƒ­ -->
        <div id="todo" class="tab-content">
            <div class="card">
                <h3><i class="fa-solid fa-list-check"></i> ì—¬í–‰ ì¤€ë¹„ ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>
                {% for category, items in checklist.items() %}
                <div class="checklist-category">
                    <h4>{{ category }}</h4>
                    {% for item in items %}
                    <div class="checklist-item">
                        <input type="checkbox" id="check{{ loop.index0 }}_{{ loop.index }}">
                        <label for="check{{ loop.index0 }}_{{ loop.index }}">{{ item }}</label>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
    </main>

    <script>
        const currentRate = {{ info.rate_calc }};
        const currentCurrency = "{{ info.currency }}";
        let userSelectedLang = 'ko';
        const currentCountryId = "{{ selected_id }}";

        // êµ­ê°€-ì–¸ì–´ ë§¤í•‘
        const countryLangMap = {
            'tokyo': 'ja',
            'osaka': 'ja',
            'fukuoka': 'ja',
            'danang': 'vi',
            'hochiminh': 'vi',
            'bangkok': 'th',
            'taipei': 'zh-TW',
            'hongkong': 'zh-TW',
            'nyc': 'en',
            'seoul': 'ko'
        };

        // ìˆ«ì ì‰¼í‘œ í¬ë§·
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function removeCommas(str) {
            return str.replace(/,/g, '');
        }

        // í™˜ìœ¨ í‘œì‹œ ì—…ë°ì´íŠ¸ (ì‰¼í‘œ í¬ë§·)
        function updateRateDisplay() {
            const rateDisplay = document.getElementById('rateDisplay');
            if (rateDisplay) {
                let displayValue;
                if (currentCurrency === 'JPY' || currentCurrency === 'VND') {
                    displayValue = formatNumber(Math.round(currentRate * 100));
                } else {
                    displayValue = formatNumber(Math.round(currentRate * 100) / 100);
                }
                rateDisplay.textContent = displayValue + 'ì›';
            }
        }

        // ì–¸ì–´ ë³€ê²½
        function changeLang(langCode) {
            userSelectedLang = langCode;
            
            // Google Translate ì ìš©
            const gtCombo = document.querySelector('.goog-te-combo');
            if (gtCombo) {
                gtCombo.value = langCode;
                gtCombo.dispatchEvent(new Event('change'));
            }
            
            document.cookie = `googtrans=/ko/${langCode}; path=/;`;
            updateTranslateButtons();
            setTimeout(() => location.reload(), 100);
        }

        // ì—¬í–‰ì§€ ë³€ê²½ (ì„ íƒí•œ êµ­ê°€ì˜ ì–¸ì–´ë¡œ ìë™ ë³€ê²½)
        function changeCity(cityId) {
            // ì–¸ì–´ë¥¼ í•´ë‹¹ êµ­ê°€ ê¸°ë³¸ ì–¸ì–´ë¡œ ë³€ê²½
            const defaultLang = countryLangMap[cityId] || 'ko';
            document.cookie = `googtrans=/ko/${defaultLang}; path=/;`;
            window.location.href = '/?country=' + cityId;
        }

        // í™˜ìœ¨ ì…ë ¥ í•„ë“œì— ì‹¤ì‹œê°„ ì‰¼í‘œ ì¶”ê°€
        document.addEventListener('DOMContentLoaded', function() {
            // í™˜ìœ¨ í‘œì‹œ ì—…ë°ì´íŠ¸
            updateRateDisplay();

            const foreignInput = document.getElementById('foreignInput');
            if (foreignInput) {
                foreignInput.addEventListener('input', function(e) {
                    let value = removeCommas(e.target.value);
                    if (value && !isNaN(value)) {
                        e.target.value = formatNumber(value);
                    }
                });
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ì–¸ì–´ ë³µì›
            const match = document.cookie.match(/googtrans=\/ko\/([^;]+)/);
            if (match) {
                userSelectedLang = match[1];
                const langSelector = document.getElementById('langSelector');
                if (langSelector) {
                    langSelector.value = match[1];
                }
            } else {
                // ì—¬í–‰ì§€ì— ë”°ë¼ ê¸°ë³¸ ì–¸ì–´ ì„¤ì •
                const defaultLang = countryLangMap[currentCountryId] || 'ko';
                userSelectedLang = defaultLang;
                const langSelector = document.getElementById('langSelector');
                if (langSelector) {
                    langSelector.value = defaultLang;
                }
                // ì²˜ìŒ ë¡œë“œì‹œ í•´ë‹¹ êµ­ê°€ ì–¸ì–´ë¡œ ì„¤ì •
                if (defaultLang !== 'ko') {
                    document.cookie = `googtrans=/ko/${defaultLang}; path=/;`;
                    setTimeout(() => location.reload(), 100);
                }
            }
            
            updateTranslateButtons();
        });

        // ë²ˆì—­ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        function updateTranslateButtons() {
            const langNames = {
                'ko': 'í•œêµ­ì–´',
                'ja': 'æ—¥æœ¬èª',
                'vi': 'Tiáº¿ng Viá»‡t',
                'th': 'à¹„à¸—à¸¢',
                'zh-CN': 'ç®€ä½“ä¸­æ–‡',
                'zh-TW': 'ç¹é«”ä¸­æ–‡',
                'en': 'English'
            };
            
            const targetBtn = document.getElementById('targetLangBtn');
            const koreanBtn = document.getElementById('koreanBtn');
            
            // ë„ì‹œì— ë”°ë¥¸ í˜„ì§€ì–´
            const cityLang = countryLangMap[currentCountryId] || 'en';
            
            if (targetBtn) {
                targetBtn.textContent = `${langNames[cityLang] || 'í˜„ì§€ì–´'}ë¡œ`;
            }
            
            if (koreanBtn) {
                // ì„ íƒí•œ ì–¸ì–´ê°€ í•œêµ­ì–´ë©´ ì˜ì–´ë¡œ, ì•„ë‹ˆë©´ í•œêµ­ì–´ë¡œ
                if (userSelectedLang === 'ko') {
                    koreanBtn.textContent = 'English';
                } else {
                    koreanBtn.textContent = 'í•œêµ­ì–´ë¡œ';
                }
            }
        }

        // ë²ˆì—­ ê¸°ëŠ¥ (ê°œì„ )
        function translateAction(mode) {
            const text = document.getElementById('sourceText').value;
            if(!text) {
                alert('ë²ˆì—­í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            let targetLang;
            if (mode === 'target') {
                // ë„ì‹œì˜ ì–¸ì–´ë¡œ ë²ˆì—­
                targetLang = countryLangMap[currentCountryId] || 'en';
            } else {
                // ì„ íƒí•œ UI ì–¸ì–´ê°€ í•œêµ­ì–´ë©´ ì˜ì–´ë¡œ, ì•„ë‹ˆë©´ í•œêµ­ì–´ë¡œ
                targetLang = userSelectedLang === 'ko' ? 'en' : 'ko';
            }
            
            fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`)
            .then(res => res.json()).then(data => {
                const rb = document.getElementById('transResult');
                if (data && data[0] && data[0][0][0]) { 
                    rb.innerText = data[0][0][0]; 
                    rb.style.display = 'block'; 
                }
            }).catch(err => {
                console.error('Translation error:', err);
                alert('ë²ˆì—­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // í™˜ìœ¨ ê³„ì‚°
        function calculateExchange() {
            const foreignInput = document.getElementById('foreignInput');
            const krwOutput = document.getElementById('krwOutput');
            let val = parseFloat(removeCommas(foreignInput.value));
            
            if (!val || isNaN(val)) {
                alert('ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (currentCurrency === 'VND' || currentCurrency === 'JPY') {
                const rounded = Math.round(val / 100) * 100;
                if (rounded !== val) {
                    foreignInput.value = formatNumber(rounded);
                    val = rounded;
                    alert(`${currentCurrency}ëŠ” 100ë‹¨ìœ„ë¡œë§Œ í™˜ì „ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n${formatNumber(rounded)}ìœ¼ë¡œ ì¡°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }
            }

            const krwAmount = Math.round(val * currentRate);
            krwOutput.value = formatNumber(krwAmount) + " ì›";
        }

        // íƒ­ ì „í™˜
        function showTab(event, id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // íšŒí™” íƒ­ ì „í™˜
        function showPhraseTab(event, id) {
            document.querySelectorAll('.phrase-tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.phrase-tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }
    </script>
</body>
</html>
