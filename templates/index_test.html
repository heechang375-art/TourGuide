<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Travel Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <script type="text/javascript">
        // ì¿ í‚¤ ì„¤ì • í•¨ìˆ˜
        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
            document.cookie = name + '=' + value + ';expires=' + expires.toUTCString() + ';path=/';
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'ko',
                includedLanguages: 'ko,ja,vi,th,zh-CN,zh-TW,en',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element');
        }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    
    <style>
        #google_translate_element { display: none !important; }
        body { top: 0 !important; }
        .skiptranslate, .goog-te-banner-frame, #goog-gt-tt { display: none !important; }
        font { background-color: transparent !important; box-shadow: none !important; }
    </style>
</head>
<body>
    <header class="app-header">
        <!-- ë‚ ì”¨ + í™˜ìœ¨ ì¹´ë“œ -->
        <div class="info-cards">
            <div class="info-card weather-card">
                <div class="info-icon">
                    <i class="fa-solid fa-cloud-sun"></i>
                </div>
                <div class="info-content">
                    <div class="info-label">í˜„ì§€ ë‚ ì”¨</div>
                    <div class="info-value">{{ info.city }} {{ info.temp }}Â°C</div>
                    <div class="info-sub">{{ info.weather_desc }}</div>
                </div>
            </div>
            
            <div class="info-card rate-card">
                <div class="info-icon">
                    <i class="fa-solid fa-coins"></i>
                </div>
                <div class="info-content">
                    <div class="info-label">í™˜ìœ¨</div>
                    <div class="info-value" id="rateDisplay">ê³„ì‚° ì¤‘...</div>
                    <div class="info-sub" id="rateCurrencyLabel"></div>
                </div>
            </div>
        </div>

        <!-- ì—¬í–‰ì§€ + ì–¸ì–´ ì„ íƒ (í•œ ì¤„) -->
        <div class="selector-row">
            <div class="selector-col">
                <label class="selector-label">ğŸŒ ì—¬í–‰ì§€</label>
                <select class="compact-selector" id="countrySelector" onchange="changeCity(this.value)">
                    {% for id, c in countries.items() %}
                    <option value="{{ id }}" {% if id == selected_id %}selected{% endif %}>{{ c.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="selector-col">
                <label class="selector-label">ğŸ—£ï¸ ì–¸ì–´</label>
                <select class="compact-selector" id="langSelector" onchange="changeLang(this.value)">
                    <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                    <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                    <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
                    <option value="th">ğŸ‡¹ğŸ‡­ à¹„à¸—à¸¢</option>
                    <option value="zh-CN">ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</option>
                    <option value="zh-TW">ğŸ‡­ğŸ‡° ç¹é«”ä¸­æ–‡</option>
                    <option value="en">ğŸ‡ºğŸ‡¸ English</option>
                </select>
            </div>
        </div>
    </header>

    <div id="google_translate_element"></div>

    <nav class="mobile-tabs">
        <button onclick="showTab(event, 'info')" class="tab-btn active">
            <i class="fa-solid fa-circle-info"></i>
            <span>ì •ë³´</span>
        </button>
        <button onclick="showTab(event, 'phrases')" class="tab-btn">
            <i class="fa-solid fa-comments"></i>
            <span>íšŒí™”</span>
        </button>
        <button onclick="showTab(event, 'shopping')" class="tab-btn">
            <i class="fa-solid fa-bag-shopping"></i>
            <span>ì‡¼í•‘</span>
        </button>
        <button onclick="showTab(event, 'calc')" class="tab-btn">
            <i class="fa-solid fa-calculator"></i>
            <span>í™˜ìœ¨</span>
        </button>
        <button onclick="showTab(event, 'todo')" class="tab-btn">
            <i class="fa-solid fa-list-check"></i>
            <span>ì²´í¬</span>
        </button>
    </nav>

    <main class="content-area">
        <!-- ì •ë³´ íƒ­ -->
        <div id="info" class="tab-content active">
            <!-- ë²ˆì—­ê¸° (ì••ì¶•) -->
            <div class="card compact-card">
                <h3><i class="fa-solid fa-language"></i> ë²ˆì—­ê¸°</h3>
                <textarea id="sourceText" class="trans-input-compact" placeholder="ë²ˆì—­í•  ë‚´ìš© ì…ë ¥..."></textarea>
                <div id="transResult" class="trans-output-compact" style="display:none;"></div>
                <div class="trans-btn-grid">
                    <button onclick="translateAction('target')" class="btn-primary" id="targetLangBtn">í˜„ì§€ì–´ë¡œ</button>
                    <button onclick="translateAction('reverse')" class="btn-success" id="reverseBtn">í•œêµ­ì–´ë¡œ</button>
                </div>
            </div>
            
            <!-- ì—¬í–‰ íŒ (ì••ì¶•) -->
            <div class="card compact-card">
                <h3><i class="fa-solid fa-lightbulb"></i> íŒ & ì£¼ì˜ì‚¬í•­</h3>
                <div class="tip-compact">
                    <strong>âœ… ê¿€íŒ</strong>
                    <ul class="compact-list">{% for tip in info.tips %}<li>{{ tip }}</li>{% endfor %}</ul>
                </div>
                <div class="warning-compact">
                    <strong>âš ï¸ ì£¼ì˜</strong>
                    <ul class="compact-list">{% for warn in info.warnings %}<li>{{ warn }}</li>{% endfor %}</ul>
                </div>
            </div>

            <!-- í•„ìˆ˜ ì•± (ì••ì¶•) -->
            <div class="card compact-card">
                <h3><i class="fa-solid fa-mobile-screen-button"></i> í•„ìˆ˜ ì•±</h3>
                {% for app in info.apps %}
                <div class="app-item-compact">
                    <div class="app-icon-small">
                        <i class="fa-solid fa-mobile-screen"></i>
                    </div>
                    <div class="app-info-small">
                        <strong>{{ app.name }}</strong>
                        <small>{{ app.desc }}</small>
                    </div>
                    <a href="{{ app.link }}" target="_blank" class="app-btn-small">
                        <i class="fa-solid fa-download"></i>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- íšŒí™” íƒ­ -->
        <div id="phrases" class="tab-content">
            <!-- íšŒí™” ì¹´í…Œê³ ë¦¬ íƒ­ -->
            <div class="phrase-tabs">
                {% set categories = info.phrases.keys() | list %}
                {% for cat in categories %}
                <button class="phrase-tab-btn {% if loop.first %}active{% endif %}" onclick="showPhraseTab(event, 'cat{{ loop.index0 }}')">
                    {{ cat.split(' ')[0] }}
                </button>
                {% endfor %}
            </div>

            <!-- íšŒí™” ë‚´ìš© -->
            {% for cat, items in info.phrases.items() %}
            <div id="cat{{ loop.index0 }}" class="phrase-tab-content {% if loop.first %}active{% endif %}">
                <div class="phrase-card-new">
                    {% for p in items %}
                    <div class="phrase-item-new">
                        <div class="phrase-ko">{{ p.ko }}</div>
                        <div class="phrase-local">{{ p.local }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- ì‡¼í•‘ íƒ­ -->
        <div id="shopping" class="tab-content">
            <div class="card">
                <h3><i class="fa-solid fa-cart-shopping"></i> ì¶”ì²œ ì‡¼í•‘í…œ</h3>
                <div class="shopping-grid">
                    {% for item in info.shopping %}
                    <a href="https://www.google.com/search?q={{ info.city }}+{{ item }}&tbm=isch" target="_blank" class="shop-item">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <span>{{ item }}</span>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- í™˜ìœ¨ ê³„ì‚°ê¸° íƒ­ -->
        <div id="calc" class="tab-content">
            <div class="card">
                <h3><i class="fa-solid fa-calculator"></i> í™˜ìœ¨ ê³„ì‚°ê¸°</h3>
                <div class="calc-box-improved">
                    <div class="calc-row">
                        <div class="currency-label" id="calcSourceCurrency">{{ info.currency }}</div>
                        <input type="text" id="foreignInput" class="calc-input" placeholder="0" inputmode="numeric">
                    </div>
                    <div class="calc-arrow">
                        <i class="fa-solid fa-arrow-down"></i>
                    </div>
                    <div class="calc-row">
                        <div class="currency-label" id="calcTargetCurrency">KRW</div>
                        <input type="text" id="krwOutput" class="calc-output" readonly placeholder="0">
                    </div>
                    <button onclick="calculateExchange()" class="calc-btn">
                        <i class="fa-solid fa-calculator"></i>
                        ê³„ì‚°í•˜ê¸°
                    </button>
                    <div class="calc-unit-info" id="calcUnitInfo" style="display:none;">
                        <i class="fa-solid fa-circle-info"></i>
                        <span><strong id="calcUnitCurrency"></strong>ëŠ” 100 ë‹¨ìœ„ë¡œë§Œ í™˜ì „ ê°€ëŠ¥í•©ë‹ˆë‹¤</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì²´í¬ë¦¬ìŠ¤íŠ¸ íƒ­ -->
        <div id="todo" class="tab-content">
            <div class="card">
                <h3><i class="fa-solid fa-list-check"></i> ì—¬í–‰ ì¤€ë¹„ ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>
                {% for category, items in checklist.items() %}
                <div class="checklist-category">
                    <h4>{{ category }}</h4>
                    {% for item in items %}
                    <div class="checklist-item">
                        <input type="checkbox" id="check{{ loop.index0 }}_{{ loop.index }}">
                        <label for="check{{ loop.index0 }}_{{ loop.index }}">{{ item }}</label>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
    </main>

    <script>
        const currentRate = {{ info.rate_calc }};
        const currentCurrency = "{{ info.currency }}";
        let userSelectedLang = 'ko';
        const currentCountryId = "{{ selected_id }}";

        // êµ­ê°€-ì–¸ì–´-í†µí™” ë§¤í•‘
        const countryLangMap = {
            'tokyo': 'ja',
            'osaka': 'ja',
            'fukuoka': 'ja',
            'danang': 'vi',
            'hochiminh': 'vi',
            'bangkok': 'th',
            'taipei': 'zh-TW',
            'hongkong': 'zh-TW',
            'nyc': 'en',
            'seoul': 'ko'
        };

        const langToCurrency = {
            'ko': 'KRW',
            'ja': 'JPY',
            'vi': 'VND',
            'th': 'THB',
            'zh-CN': 'TWD',
            'zh-TW': 'TWD',
            'en': 'USD'
        };

        // í˜„ì¬ í™˜ìœ¨ ë°ì´í„° ì €ì¥
        let currentDisplayRate = currentRate;
        let sourceCurrency = currentCurrency;
        let targetCurrency = 'KRW';

        // ìˆ«ì ì‰¼í‘œ í¬ë§·
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function removeCommas(str) {
            return str.replace(/,/g, '');
        }

        // í™˜ìœ¨ API í˜¸ì¶œ
        async function fetchExchangeRate(from, to) {
            try {
                const response = await fetch(`https://open.er-api.com/v6/latest/${from}`);
                const data = await response.json();
                return data.rates[to] || 1;
            } catch (error) {
                console.error('Exchange rate fetch error:', error);
                return 1;
            }
        }

        // í™˜ìœ¨ í‘œì‹œ ì—…ë°ì´íŠ¸
        async function updateRateDisplay() {
            const rateDisplay = document.getElementById('rateDisplay');
            const rateCurrencyLabel = document.getElementById('rateCurrencyLabel');
            
            if (!rateDisplay || !rateCurrencyLabel) return;

            const langCurrency = langToCurrency[userSelectedLang];
            
            if (langCurrency === currentCurrency) {
                rateDisplay.textContent = '-';
                rateCurrencyLabel.textContent = '(ê°™ì€ í†µí™”)';
                sourceCurrency = currentCurrency;
                targetCurrency = currentCurrency;
                currentDisplayRate = 1;
                return;
            }

            sourceCurrency = currentCurrency;
            targetCurrency = langCurrency;
            
            const rate = await fetchExchangeRate(sourceCurrency, targetCurrency);
            currentDisplayRate = rate;

            let displayValue;
            let baseAmount;
            
            if (sourceCurrency === 'JPY' || sourceCurrency === 'VND') {
                baseAmount = 100;
                displayValue = formatNumber(Math.round(rate * 100 * 100) / 100);
            } else {
                baseAmount = 1;
                displayValue = formatNumber(Math.round(rate * 100) / 100);
            }
            
            rateCurrencyLabel.textContent = `${baseAmount} ${sourceCurrency}`;
            rateDisplay.textContent = displayValue + ' ' + targetCurrency;
        }

        // Google Translate íŠ¸ë¦¬ê±° í•¨ìˆ˜
        function triggerGoogleTranslate(lang) {
            let checkCount = 0;
            const maxChecks = 50;
            
            const interval = setInterval(() => {
                const selectElem = document.querySelector('.goog-te-combo');
                if (selectElem) {
                    selectElem.value = lang;
                    selectElem.dispatchEvent(new Event('change'));
                    clearInterval(interval);
                    console.log('Google Translate activated:', lang);
                } else {
                    checkCount++;
                    if (checkCount >= maxChecks) {
                        clearInterval(interval);
                        console.log('Google Translate widget not found');
                    }
                }
            }, 100);
        }

        // ì–¸ì–´ ë³€ê²½
        function changeLang(langCode) {
            console.log('Changing language to:', langCode);
            userSelectedLang = langCode;
            
            // ê¸°ì¡´ ì¿ í‚¤ ì™„ì „íˆ ì‚­ì œ
            document.cookie.split(";").forEach(function(c) { 
                if (c.trim().startsWith('googtrans')) {
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                }
            });
            
            // ìƒˆ ì¿ í‚¤ ì„¤ì •
            setCookie('googtrans', `/ko/${langCode}`, 365);
            setCookie('selectedLang', langCode, 365);
            
            console.log('Cookie set to:', `/ko/${langCode}`);
            
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ Google Translate ê°•ì œ ì¬ì‹œì‘
            setTimeout(() => {
                window.location.reload();
            }, 100);
        }

        // ì—¬í–‰ì§€ ë³€ê²½
        function changeCity(cityId) {
            // ëª¨ë“  ì¿ í‚¤ ì´ˆê¸°í™”
            setCookie('googtrans', '', -1);
            setCookie('selectedLang', '', -1);
            window.location.href = '/?country=' + cityId;
        }

        // í™˜ìœ¨ ê³„ì‚°ê¸° í†µí™” ì—…ë°ì´íŠ¸
        function updateCalcCurrencies() {
            const calcSourceCurrency = document.getElementById('calcSourceCurrency');
            const calcTargetCurrency = document.getElementById('calcTargetCurrency');
            const calcUnitInfo = document.getElementById('calcUnitInfo');
            const calcUnitCurrency = document.getElementById('calcUnitCurrency');

            if (calcSourceCurrency) calcSourceCurrency.textContent = sourceCurrency;
            if (calcTargetCurrency) calcTargetCurrency.textContent = targetCurrency;

            if (calcUnitInfo && calcUnitCurrency) {
                if (sourceCurrency === 'JPY' || sourceCurrency === 'VND') {
                    calcUnitInfo.style.display = 'flex';
                    calcUnitCurrency.textContent = sourceCurrency;
                } else {
                    calcUnitInfo.style.display = 'none';
                }
            }
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            const foreignInput = document.getElementById('foreignInput');
            if (foreignInput) {
                foreignInput.addEventListener('input', function(e) {
                    let value = removeCommas(e.target.value);
                    if (value && !isNaN(value)) {
                        e.target.value = formatNumber(value);
                    }
                });
            }

            // ì €ì¥ëœ ì–¸ì–´ ë¶ˆëŸ¬ì˜¤ê¸°
            const savedLang = getCookie('selectedLang');
            if (savedLang) {
                userSelectedLang = savedLang;
            } else {
                userSelectedLang = 'ko';
            }

            // ì–¸ì–´ ì„ íƒê¸° ì„¤ì •
            const langSelector = document.getElementById('langSelector');
            if (langSelector) {
                langSelector.value = userSelectedLang;
            }

            // Google Translate ì´ˆê¸°í™” (ì–¸ì–´ê°€ í•œêµ­ì–´ê°€ ì•„ë‹Œ ê²½ìš°)
            if (userSelectedLang !== 'ko') {
                triggerGoogleTranslate(userSelectedLang);
            }
            
            // í™˜ìœ¨ í‘œì‹œ ì—…ë°ì´íŠ¸
            updateRateDisplay();
            updateTranslateButtons();
            updateCalcCurrencies();
        });

        // ë²ˆì—­ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        function updateTranslateButtons() {
            const langNames = {
                'ko': 'í•œêµ­ì–´',
                'ja': 'æ—¥æœ¬èª',
                'vi': 'Tiáº¿ng Viá»‡t',
                'th': 'à¹„à¸—à¸¢',
                'zh-CN': 'ç®€ä½“ä¸­æ–‡',
                'zh-TW': 'ç¹é«”ä¸­æ–‡',
                'en': 'English'
            };
            
            const targetBtn = document.getElementById('targetLangBtn');
            const reverseBtn = document.getElementById('reverseBtn');
            
            const cityLang = countryLangMap[currentCountryId] || 'en';
            
            if (targetBtn) {
                targetBtn.textContent = `${langNames[cityLang] || 'í˜„ì§€ì–´'}ë¡œ`;
            }
            
            if (reverseBtn) {
                if (userSelectedLang === 'ko') {
                    reverseBtn.textContent = 'English';
                } else {
                    reverseBtn.textContent = 'í•œêµ­ì–´ë¡œ';
                }
            }
        }

        // ë²ˆì—­ ê¸°ëŠ¥
        function translateAction(mode) {
            const text = document.getElementById('sourceText').value;
            if(!text) {
                alert('ë²ˆì—­í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            let targetLang;
            if (mode === 'target') {
                targetLang = countryLangMap[currentCountryId] || 'en';
            } else {
                targetLang = userSelectedLang === 'ko' ? 'en' : 'ko';
            }
            
            fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`)
            .then(res => res.json()).then(data => {
                const rb = document.getElementById('transResult');
                if (data && data[0] && data[0][0][0]) { 
                    rb.innerText = data[0][0][0]; 
                    rb.style.display = 'block'; 
                }
            }).catch(err => {
                console.error('Translation error:', err);
                alert('ë²ˆì—­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // í™˜ìœ¨ ê³„ì‚°
        function calculateExchange() {
            const foreignInput = document.getElementById('foreignInput');
            const krwOutput = document.getElementById('krwOutput');
            let val = parseFloat(removeCommas(foreignInput.value));
            
            if (!val || isNaN(val)) {
                alert('ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (sourceCurrency === 'VND' || sourceCurrency === 'JPY') {
                const rounded = Math.round(val / 100) * 100;
                if (rounded !== val) {
                    foreignInput.value = formatNumber(rounded);
                    val = rounded;
                    alert(`${sourceCurrency}ëŠ” 100ë‹¨ìœ„ë¡œë§Œ í™˜ì „ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n${formatNumber(rounded)}ìœ¼ë¡œ ì¡°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }
            }

            const resultAmount = Math.round(val * currentDisplayRate);
            krwOutput.value = formatNumber(resultAmount) + " " + targetCurrency;
        }

        // íƒ­ ì „í™˜
        function showTab(event, id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // íšŒí™” íƒ­ ì „í™˜
        function showPhraseTab(event, id) {
            document.querySelectorAll('.phrase-tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.phrase-tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }
    </script>
</body>
</html>
